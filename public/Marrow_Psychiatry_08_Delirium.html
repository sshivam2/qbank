<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>08_Delirium - Marrow Psychiatry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .medical-quiz {
            font-family: Segoe UI, Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .question-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .option-card {
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .option-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
        }
        
        .option-card.selected {
            background: #3b82f6;
            color: white;
            border-color: #1d4ed8;
        }
        
        .option-card.correct {
            background: #10b981;
            color: white;
            border-color: #059669;
        }
        
        .option-card.incorrect {
            background: #ef4444;
            color: white;
            border-color: #dc2626;
        }
        
        .progress-bar {
            background: linear-gradient(to right, #10b981, #059669);
            transition: width 0.3s;
        }
        
        .medical-image {
            max-width: 100%;
            max-height: 400px;
            height: auto;
            border-radius: 12px;
            margin: 20px auto;
            display: block;
        }
        
        .hidden {
            display: none !important;
        }

        .explanation-content {
            font-family: Segoe UI, Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1.05rem;
            line-height: 1.7;
            color: #374151;
            text-align: left;
        }
        
        .explanation-content p {
            margin-bottom: 1rem;
            text-align: justify;
        }
        
        .explanation-content strong, .explanation-content b {
            font-weight: 600;
            color: #1f2937;
        }
        
        .explanation-content img {
            max-width: 100%;
            height: auto;
            margin: 1.5rem auto;
            display: block;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen medical-quiz">
    <header class="bg-white shadow-xl p-6">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">08_Delirium</h1>
                <p class="text-gray-600 mt-2">Marrow ‚Ä¢ Psychiatry ‚Ä¢ Interactive Learning</p>
            </div>
            <div class="flex gap-2">
                <button class="bg-gray-500 text-white px-3 py-2 text-sm rounded-lg hover:bg-gray-600 transition" 
                        onclick="window.location.href='marrow_psychiatry.html'">
                    ‚Üê Topics
                </button>
                <button class="bg-purple-500 text-white px-3 py-2 text-sm rounded-lg hover:bg-purple-600 transition" 
                        onclick="window.location.href='marrow.html'">
                    üìö Marrow
                </button>
                <button class="bg-blue-500 text-white px-3 py-2 text-sm rounded-lg hover:bg-blue-600 transition" 
                        onclick="window.location.href='index.html'">
                    üè† Home
                </button>
            </div>
        </div>
    </header>

    <!-- Statistics Bar (Hidden in Test Mode) -->
    <div class="bg-white shadow-lg p-4" id="stats-bar">
        <div class="container mx-auto flex justify-center gap-8">
            <div class="text-center">
                <div class="text-2xl font-bold text-green-600" id="correct-stats">0</div>
                <div class="text-sm text-gray-600">Correct</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-red-600" id="incorrect-stats">0</div>
                <div class="text-sm text-gray-600">Incorrect</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-blue-600" id="accuracy-stats">0%</div>
                <div class="text-sm text-gray-600">Accuracy</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-purple-600" id="progress-stats">0/9</div>
                <div class="text-sm text-gray-600">Progress</div>
            </div>
        </div>
    </div>

    <!-- Quiz Section -->
    <section class="container mx-auto p-6" id="quiz-section">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <!-- Progress Bar -->
            <div class="w-full bg-gray-200 rounded-full h-4 mb-8">
                <div class="progress-bar h-4 rounded-full" id="progress-bar"></div>
            </div>

            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold text-blue-700" id="question-number">Question 1 of 9</h2>
                <div class="text-sm text-gray-600" id="question-status">Click an option to answer</div>
            </div>

            <!-- Question Text -->
            <div class="mb-10">
                <div class="question-card text-white p-8 rounded-2xl mb-8" id="question-text"></div>
                
                <!-- Question Image -->
                <div class="text-center mb-8" id="question-images"></div>
                
                <!-- Options -->
                <div class="space-y-4" id="options"></div>
            </div>

            <!-- Answer Feedback Section (Normal Mode Only) -->
            <div class="hidden mb-8 p-6 rounded-2xl" id="feedback-section">
                <div class="text-center mb-4">
                    <div class="text-6xl mb-2" id="feedback-icon"></div>
                    <div class="text-2xl font-bold mb-2" id="feedback-message">Correct!</div>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div class="bg-white p-4 rounded-xl border">
                        <strong>Your Answer:</strong><br>
                        <span id="user-answer-display"></span>
                    </div>
                    <div class="bg-white p-4 rounded-xl border">
                        <strong>Correct Answer:</strong><br>
                        <span class="text-green-600" id="correct-answer-display"></span>
                    </div>
                </div>
                
                <div class="bg-blue-50 p-6 rounded-xl" id="explanation-section">
                    <strong class="text-lg text-blue-800">Explanation:</strong>
                    <div id="explanation-content" class="mt-3 explanation-content"></div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="flex justify-between gap-4">
                <button class="bg-gray-400 text-white px-6 py-3 rounded-xl hover:bg-gray-500 transition" 
                        onclick="window.location.href='marrow_psychiatry.html'">
                    Back to Topics
                </button>
                
                <div class="flex gap-4">
                    <button class="bg-gray-400 text-white px-6 py-3 rounded-xl disabled" id="prev-btn">
                        Previous
                    </button>
                    <button class="bg-blue-500 text-white px-6 py-3 rounded-xl hidden" id="next-btn">
                        Next
                    </button>
                    <button class="bg-green-600 text-white px-6 py-3 rounded-xl font-bold hidden" id="finish-btn">
                        Finish Quiz
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Test Mode Final Results -->
    <section class="container mx-auto p-6 hidden" id="test-results">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <div class="text-center mb-8">
                <h2 class="text-4xl font-bold mb-4 text-blue-700">Test Complete! üéâ</h2>
                <div class="text-6xl mb-4" id="test-grade-icon">üéØ</div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-green-100 p-6 rounded-2xl text-center">
                    <div class="text-4xl font-bold text-green-600" id="test-final-correct">0</div>
                    <div class="font-semibold text-green-700">Correct Answers</div>
                </div>
                <div class="bg-red-100 p-6 rounded-2xl text-center">
                    <div class="text-4xl font-bold text-red-600" id="test-final-incorrect">0</div>
                    <div class="font-semibold text-red-700">Incorrect Answers</div>
                </div>
                <div class="bg-blue-100 p-6 rounded-2xl text-center">
                    <div class="text-4xl font-bold text-blue-600" id="test-final-accuracy">0%</div>
                    <div class="font-semibold text-blue-700">Final Accuracy</div>
                </div>
            </div>

            <!-- Detailed Review -->
            <div class="mb-8">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">üìã Detailed Review</h3>
                <div id="test-review-details" class="space-y-4"></div>
            </div>
            
            <div class="flex justify-center gap-4">
                <button class="bg-purple-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-purple-700 transition" 
                        onclick="window.location.href='marrow_psychiatry.html'">
                    Back to Topics
                </button>
                <button class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-700 transition" 
                        onclick="window.location.reload()">
                    Retake Quiz
                </button>
            </div>
        </div>
    </section>

    <!-- Normal Mode Final Results -->
    <section class="container mx-auto p-6 hidden" id="final-results">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <div class="text-center mb-8">
                <h2 class="text-4xl font-bold mb-4 text-blue-700">Quiz Complete! üéâ</h2>
                <div class="text-6xl mb-4" id="final-grade-icon">üéØ</div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-green-100 p-6 rounded-2xl text-center">
                    <div class="text-4xl font-bold text-green-600" id="final-correct">0</div>
                    <div class="font-semibold text-green-700">Correct Answers</div>
                </div>
                <div class="bg-red-100 p-6 rounded-2xl text-center">
                    <div class="text-4xl font-bold text-red-600" id="final-incorrect">0</div>
                    <div class="font-semibold text-red-700">Incorrect Answers</div>
                </div>
                <div class="bg-blue-100 p-6 rounded-2xl text-center">
                    <div class="text-4xl font-bold text-blue-600" id="final-accuracy">0%</div>
                    <div class="font-semibold text-blue-700">Final Accuracy</div>
                </div>
            </div>
            
            <div class="flex justify-center gap-4">
                <button class="bg-purple-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-purple-700 transition" 
                        onclick="window.location.href='marrow_psychiatry.html'">
                    Back to Topics
                </button>
                <button class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-700 transition" 
                        onclick="window.location.reload()">
                    Retake Quiz
                </button>
            </div>
        </div>
    </section>

    <script>
        const questions = [
  {
    "id": 123,
    "text": "Q1. 72-year old woman is admitted with complaints of fever with dysuria for 5 days. On examination, she is drowsy and appears withdrawn and apathetic. She claims to see bugs crawling on her hand. What is the diagnosis?",
    "options": [
      {
        "label": "A",
        "text": "Dementia",
        "correct": false
      },
      {
        "label": "B",
        "text": "Schizophrenia",
        "correct": false
      },
      {
        "label": "C",
        "text": "Formication",
        "correct": false
      },
      {
        "label": "D",
        "text": "Delirium",
        "correct": true
      }
    ],
    "imageData": null,
    "explanationHTML": "<div class=\"explanation\">The given clinical scenario of an acute decline in the level of awareness and visual hallucinations (seeing bugs crawling on hand) in an elderly female admitted with fever and dysuria suggests a diagnosis of delirium. Delirium is characterized by: ¬´ Acute decline in the level of awareness * Global impairment of cognitive functions (particularly attention) It also involves: ¬¢ Perceptual disturbances like illusions and hallucinations ¬¢ Abnormal psychomotor activity * Sleep cycle impairment Formication is a tactile (not visual) hallucination in which the patient experiences a feeling of insects crawling under the skin.</div><div class=\"telegram-link\"><small><a href=\"http://t.me/Friendly_neighborhood_medico_bot\"> </a></small></div>",
    "subdeck": "08_Delirium",
    "deck_id": 1755954606421,
    "correctAnswer": "D. Delirium"
  },
  {
    "id": 124,
    "text": "Q2. Which of the following features is more in favour of delirium?",
    "options": [
      {
        "label": "A",
        "text": "Occurs gradually over a period of time",
        "correct": false
      },
      {
        "label": "B",
        "text": "Fluctuating course",
        "correct": true
      },
      {
        "label": "C",
        "text": "Preserved consciousness",
        "correct": false
      },
      {
        "label": "D",
        "text": "Commonly associated with auditory hallucinations",
        "correct": false
      }
    ],
    "imageData": null,
    "explanationHTML": "<div class=\"explanation\">Fluctuating course is suggestive of delirium. Characteristic presentation of delirium: * Acute onset ¬¢ Brief duration - usually days to weeks * Decline in the level of consciousness. * Fluctuating course - unpredictable fluctuations in severity and other clinical manifestations * Sundowning - worsening of symptoms at night * Rapid improvement - when the underlying cause is treated * Other characteristics include asterixis, carphologia (picking movements on cover sheets and clothes) * More commonly associated with visual hallucinations</div><div class=\"telegram-link\"><small><a href=\"http://t.me/Friendly_neighborhood_medico_bot\"> </a></small></div>",
    "subdeck": "08_Delirium",
    "deck_id": 1755954606421,
    "correctAnswer": "B. Fluctuating course"
  },
  {
    "id": 125,
    "text": "Q3. Which neurotransmitter abnormality is identified most consistently in patients with delirium?",
    "options": [
      {
        "label": "A",
        "text": "Decreased dopamine",
        "correct": false
      },
      {
        "label": "B",
        "text": "Decreased acetylcholine",
        "correct": true
      },
      {
        "label": "C",
        "text": "Increased GABA",
        "correct": false
      },
      {
        "label": "D",
        "text": "Increased glutamate",
        "correct": false
      }
    ],
    "imageData": null,
    "explanationHTML": "<div class=\"explanation\">The most consistent neurotransmitter abnormality seen in delirium is cholinergic deficiency (decreased acetylcholine). The major neuroanatomical area associated with the condition is reticular formation. 112 Neurotransmitter abnormalities in delirium: * Decreased acetylcholine * Increased dopamine * Increased norepinephrine</div><div class=\"telegram-link\"><small><a href=\"http://t.me/Friendly_neighborhood_medico_bot\"> </a></small></div>",
    "subdeck": "08_Delirium",
    "deck_id": 1755954606421,
    "correctAnswer": "B. Decreased acetylcholine"
  },
  {
    "id": 126,
    "text": "Q4. patient admitted to the ICU for severe pneumonia 5 days ago suddenly developed difficulty in recognizing his relatives or the doctor and has started muttering that he is trapped in jail. 109 On evaluation, he is in an altered sensorium. What is the most likely diagnosis?",
    "options": [
      {
        "label": "A",
        "text": "Acute dementia",
        "correct": false
      },
      {
        "label": "B",
        "text": "Brief psychotic disorder",
        "correct": false
      },
      {
        "label": "C",
        "text": "ICU psychosis",
        "correct": true
      },
      {
        "label": "D",
        "text": "Acute paranoia",
        "correct": false
      }
    ],
    "imageData": null,
    "explanationHTML": "<div class=\"explanation\">The given clinical scenario is suggestive of ICU psychosis (delirium). The following features are consistent with the diagnosis of delirium: * Acute onset of symptoms * Disorientation to place (jail instead of the hospital) * Disorientation to person (failure to recognize relatives and the doctor) * Altered sensorium Brief psychotic disorder (BPD) according to DSM-5 is the sudden onset of psychotic behaviour that lasts less than 1 month followed by complete remission with possible future relapses. This is termed acute and transient psychotic disorder as per ICD-11, and the duration of the episode should not exceed 3 months.</div><div class=\"telegram-link\"><small><a href=\"http://t.me/Friendly_neighborhood_medico_bot\"> </a></small></div>",
    "subdeck": "08_Delirium",
    "deck_id": 1755954606421,
    "correctAnswer": "C. ICU psychosis"
  },
  {
    "id": 127,
    "text": "Q5. You are evaluating an elderly man who is suspected to have hypoactive delirium. Which of the following etiologies is most commonly associated with his condition?",
    "options": [
      {
        "label": "A",
        "text": "Anticholinergic drug overdose",
        "correct": false
      },
      {
        "label": "B",
        "text": "Heavy metal poisoning",
        "correct": false
      },
      {
        "label": "C",
        "text": "Hepatic encephalopathy",
        "correct": true
      },
      {
        "label": "D",
        "text": "Alcohol withdrawal",
        "correct": false
      }
    ],
    "imageData": null,
    "explanationHTML": "<div class=\"explanation\">Hypoactive delirium is commonly associated with hepatic and renal encephalopathies. The hypoactive clinical subtype of delirium can often be confused with depression due to overlapping symptoms of psychomotor retardation and affect. In delirium, however, the onset of such symptoms is more acute and is usually associated with some medical illness.</div><div class=\"telegram-link\"><small><a href=\"http://t.me/Friendly_neighborhood_medico_bot\"> </a></small></div>",
    "subdeck": "08_Delirium",
    "deck_id": 1755954606421,
    "correctAnswer": "C. Hepatic encephalopathy"
  },
  {
    "id": 128,
    "text": "Q6. Among patients who develop acute psychiatric symptoms in the hospital, which of the following screening tools is useful for identifying cases of delirium?",
    "options": [
      {
        "label": "A",
        "text": "CAGE questionnaire",
        "correct": false
      },
      {
        "label": "B",
        "text": "CHAT checklist",
        "correct": false
      },
      {
        "label": "C",
        "text": "CAM algorithm",
        "correct": true
      },
      {
        "label": "D",
        "text": "GAD-7 scale",
        "correct": false
      }
    ],
    "imageData": null,
    "explanationHTML": "<div class=\"explanation\">Confusion assessment method (CAM) is a bedside screening test used in the diagnosis of delirium. It has two parts: * Part one - screens for overall cognitive impairment. * Part two - a diagnostic algorithm that screens for 4 cardinal features to distinguish delirium from other types of cognitive impairment. It can be assessed in less than 5 minutes. Diagnosis of delirium requires the presence of features 1 and 2 along with either feature 3 or 4. i. e. , features 1+ 2 + (3 or 4) 113 Option A: CAGE questionnaire is used for addiction and substance abuse cases Option B: CHAT checklist is used in autism (CHecklist for Autism in Toddlers) Option D: GAD-7 scale is used in the assessment of generalized anxiety disorder Feature 1 Acute onset and fluctuating c ourse Disorganized thinking Altered level of consciousnes Ss</div><div class=\"telegram-link\"><small><a href=\"http://t.me/Friendly_neighborhood_medico_bot\"> </a></small></div>",
    "subdeck": "08_Delirium",
    "deck_id": 1755954606421,
    "correctAnswer": "C. CAM algorithm"
  },
  {
    "id": 129,
    "text": "Q7. An elderly man was brought in to get evaluated for suspected depressive disorder. He has been socially withdrawn, confused, and has not been speaking to his family for the past 1 week. The family also complains that he has not been sleeping well at night. Which of the following EEG findings would make you suspect delirium?",
    "options": [
      {
        "label": "A",
        "text": "Chaotic",
        "correct": false
      },
      {
        "label": "B",
        "text": "3Hz Spike and wave",
        "correct": false
      },
      {
        "label": "C",
        "text": "Diffuse slow wave",
        "correct": true
      },
      {
        "label": "D",
        "text": "Isoelectric 110",
        "correct": false
      }
    ],
    "imageData": null,
    "explanationHTML": "<div class=\"explanation\">The EEG finding in most patients with delirium is diffuse slow-wave or low-voltage activity. EEG findings in specific causes of delirium: * Focal impairment - localized cerebral event * Low voltage but fast-wave activity - drug/alcohol withdrawal Option A: Chaotic (hypsarrhythmia) ‚Äî Infantile spasm, West syndrome Option B: 3Hz spike and wave ‚Äî Absence seizures Option D: Isoelectric EEG ‚Äî Deep coma / cerebral death</div><div class=\"telegram-link\"><small><a href=\"http://t.me/Friendly_neighborhood_medico_bot\"> </a></small></div>",
    "subdeck": "08_Delirium",
    "deck_id": 1755954606421,
    "correctAnswer": "C. Diffuse slow wave"
  },
  {
    "id": 130,
    "text": "Q8. When pharmacotherapy is necessary for managing delirium, which of the following is preferred as the first-line treatment?",
    "options": [
      {
        "label": "A",
        "text": "Lorazepam 1 mg PO",
        "correct": false
      },
      {
        "label": "B",
        "text": "Lorazepam 0.5 mg IV",
        "correct": false
      },
      {
        "label": "C",
        "text": "Clozapine 12.5mg PO",
        "correct": false
      },
      {
        "label": "D",
        "text": "Haloperidol 0.5 mg PO",
        "correct": true
      }
    ],
    "imageData": null,
    "explanationHTML": "<div class=\"explanation\">Haloperidol is commonly used for the first-line pharmacological treatment of delirium. The two major symptoms of delirium that may require pharmacological treatment are psychosis and insomnia. Options A, B: Benzodiazepines are often used as an adjunct in agitated patients, but should be used judiciously for insomnia as their sedative property can worsen confusion in delirium. Option C: The use of second-generation antipsychotics may be considered for delirium management, but clinical trial experience with these agents for delirium is limited. Clozapine itself is known to sometimes trigger delirium. Note: IV regimens of haloperidol are mostly used in the ICU in the critically ill due to their fast onset of action and predictable pharmacokinetics. Oral haloperidol may be used as a maintenance regimen in patients with a functional GI tract. Intramuscular haloperidol is considered only in acutely combative patients without IV access. 114</div><div class=\"telegram-link\"><small><a href=\"http://t.me/Friendly_neighborhood_medico_bot\"> </a></small></div>",
    "subdeck": "08_Delirium",
    "deck_id": 1755954606421,
    "correctAnswer": "D. Haloperidol 0.5 mg PO"
  },
  {
    "id": 131,
    "text": "Q9. 75-year old patient with Parkinson&apos;s disease, taking levodopa for the past 2 years, presents to you with disorientation, confusion, and altered sensorium. What is your next step in management?",
    "options": [
      {
        "label": "A",
        "text": "Reduce the dose of levodopa ee ee ee ee ee ee ee ee ee ee ee ee ee 111",
        "correct": true
      },
      {
        "label": "B",
        "text": "IV Lorazepam",
        "correct": false
      },
      {
        "label": "C",
        "text": "Oral Quetiapine",
        "correct": false
      },
      {
        "label": "D",
        "text": "Oral Clozapine",
        "correct": false
      }
    ],
    "imageData": null,
    "explanationHTML": "<div class=\"explanation\">The next step in management should be a reduction in the dose of levodopa. The patient presents with disorientation, confusion and altered sensorium. This is suggestive of delirium. Anti-parkinsonian agents are frequently implicated in causing delirium because of dopamine increase. Decreasing the dosage of the antiparkinsonian agent has to be weighed against worsening of motor symptoms. Clozapine is recommended when: ¬¢ The antiparkinsonian agents cannot be further reduced * Delirium persists even after reducing the dose of antiparkinsonian agents If a patient is not able to tolerate clozapine, alternative antipsychotic agents should be considered. 115</div><div class=\"telegram-link\"><small><a href=\"http://t.me/Friendly_neighborhood_medico_bot\"> </a></small></div>",
    "subdeck": "08_Delirium",
    "deck_id": 1755954606421,
    "correctAnswer": "A. Reduce the dose of levodopa ee ee ee ee ee ee ee ee ee ee ee ee ee 111"
  }
];
        let currentQuestion = 0;
        let answers = [];
        let correctCount = 0;
        let incorrectCount = 0;
        let answeredQuestions = new Set();
        let isTestMode = localStorage.getItem('testMode') === 'true' || false;

        console.log('Quiz loaded with', questions.length, 'questions');
        console.log('Test mode:', isTestMode);

        // Hide stats bar if test mode is enabled
        if (isTestMode) {
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('stats-bar').style.display = 'none';
            });
        }

        // Auto-start quiz
        startQuiz();

        function startQuiz() {
            answers = new Array(questions.length).fill(null);
            correctCount = 0;
            incorrectCount = 0;
            answeredQuestions = new Set();
            currentQuestion = 0;
            showQuestion(0);
            updateStats();
        }

        function showQuestion(index) {
            currentQuestion = index;
            const question = questions[index];

            document.getElementById('question-number').textContent = `Question ${index + 1} of ${questions.length}`;
            document.getElementById('question-text').innerHTML = question.text;
            document.getElementById('question-status').textContent = answers[index] ? 'Question answered' : 'Click an option to answer';

            const imagesContainer = document.getElementById('question-images');
            imagesContainer.innerHTML = '';

            if (question.imageData) {
                const img = document.createElement('img');
                img.src = `data:${question.imageData.mime};base64,${question.imageData.data}`;
                img.className = 'medical-image';
                img.alt = 'Medical Question Image';
                imagesContainer.appendChild(img);
            }

            const optionsContainer = document.getElementById('options');
            optionsContainer.innerHTML = '';

            question.options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-card w-full p-6 text-left bg-white rounded-xl shadow-lg';
                button.innerHTML = `<span class="font-bold text-blue-600 mr-4">${option.label}.</span>${option.text}`;

                if (!isTestMode && answers[index] !== null) {
                    button.disabled = true;
                    if (option.correct) {
                        button.classList.add('correct');
                    } else if (answers[index] === option.label) {
                        button.classList.add('incorrect');
                    }
                } else {
                    button.onclick = () => selectAnswer(option.label);
                }

                if (answers[index] === option.label) {
                    button.classList.add('selected');
                }

                optionsContainer.appendChild(button);
            });

            // Show feedback only in normal mode and if answered
            if (!isTestMode && answers[index] !== null) {
                showFeedback(index);
            } else {
                document.getElementById('feedback-section').classList.add('hidden');
            }

            document.getElementById('prev-btn').disabled = index === 0;

            if (answers[index] !== null) {
                if (index === questions.length - 1) {
                    document.getElementById('next-btn').classList.add('hidden');
                    document.getElementById('finish-btn').classList.remove('hidden');
                } else {
                    document.getElementById('next-btn').classList.remove('hidden');
                    document.getElementById('finish-btn').classList.add('hidden');
                }
            } else {
                document.getElementById('next-btn').classList.add('hidden');
                document.getElementById('finish-btn').classList.add('hidden');
            }

            const progress = ((index + 1) / questions.length) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
        }

        function selectAnswer(label) {
            const question = questions[currentQuestion];
            const correctOption = question.options.find(opt => opt.correct);
            const isCorrect = correctOption && label === correctOption.label;

            if (!answeredQuestions.has(currentQuestion)) {
                answeredQuestions.add(currentQuestion);
                if (isCorrect) {
                    correctCount++;
                } else {
                    incorrectCount++;
                }
            }

            answers[currentQuestion] = label;
            updateStats();
            
            showQuestion(currentQuestion);
        }

        function showFeedback(questionIndex) {
            const question = questions[questionIndex];
            const userAnswer = answers[questionIndex];
            const correctOption = question.options.find(opt => opt.correct);
            const userOption = question.options.find(opt => opt.label === userAnswer);
            const isCorrect = correctOption && userAnswer === correctOption.label;

            const feedbackSection = document.getElementById('feedback-section');
            const feedbackIcon = document.getElementById('feedback-icon');
            const feedbackMessage = document.getElementById('feedback-message');

            if (isCorrect) {
                feedbackSection.className = 'bg-green-50 border border-green-200 mb-8 p-6 rounded-2xl';
                feedbackIcon.textContent = '‚úÖ';
                feedbackMessage.textContent = 'Correct!';
                feedbackMessage.className = 'text-2xl font-bold mb-2 text-green-700';
            } else {
                feedbackSection.className = 'bg-red-50 border border-red-200 mb-8 p-6 rounded-2xl';
                feedbackIcon.textContent = '‚ùå';
                feedbackMessage.textContent = 'Incorrect';
                feedbackMessage.className = 'text-2xl font-bold mb-2 text-red-700';
            }

            document.getElementById('user-answer-display').innerHTML = `<span class="${isCorrect ? 'text-green-600' : 'text-red-600'}">${userAnswer}. ${userOption?.text || 'Unknown'}</span>`;
            document.getElementById('correct-answer-display').textContent = question.correctAnswer;

            const explanationSection = document.getElementById('explanation-section');
            if (question.explanationHTML && question.explanationHTML.trim()) {
                document.getElementById('explanation-content').innerHTML = question.explanationHTML;
                explanationSection.classList.remove('hidden');
            } else {
                explanationSection.classList.add('hidden');
            }

            feedbackSection.classList.remove('hidden');
        }

        function updateStats() {
            const totalAnswered = correctCount + incorrectCount;
            const accuracy = totalAnswered === 0 ? 0 : Math.round((correctCount / totalAnswered) * 100);

            document.getElementById('correct-stats').textContent = correctCount;
            document.getElementById('incorrect-stats').textContent = incorrectCount;
            document.getElementById('accuracy-stats').textContent = `${accuracy}%`;
            document.getElementById('progress-stats').textContent = `${totalAnswered}/${questions.length}`;
        }

        document.getElementById('prev-btn').onclick = () => {
            if (currentQuestion > 0) {
                showQuestion(currentQuestion - 1);
            }
        };
        
        document.getElementById('next-btn').onclick = () => {
            if (currentQuestion < questions.length - 1) {
                showQuestion(currentQuestion + 1);
            }
        };
        
        document.getElementById('finish-btn').onclick = showFinalResults;

        function showFinalResults() {
            if (isTestMode) {
                showTestModeResults();
            } else {
                showNormalModeResults();
            }
        }

        function showTestModeResults() {
            const accuracy = (correctCount + incorrectCount === 0) ? 0 : Math.round((correctCount / (correctCount + incorrectCount)) * 100);

            document.getElementById('quiz-section').classList.add('hidden');
            document.getElementById('test-results').classList.remove('hidden');

            document.getElementById('test-final-correct').textContent = correctCount;
            document.getElementById('test-final-incorrect').textContent = incorrectCount;
            document.getElementById('test-final-accuracy').textContent = `${accuracy}%`;

            let gradeIcon = 'üéØ';
            if (accuracy >= 90) {
                gradeIcon = 'üèÜ';
            } else if (accuracy >= 80) {
                gradeIcon = 'üéâ';
            } else if (accuracy >= 70) {
                gradeIcon = 'üëç';
            } else if (accuracy >= 60) {
                gradeIcon = 'üìö';
            } else {
                gradeIcon = 'üí™';
            }

            document.getElementById('test-grade-icon').textContent = gradeIcon;

            // Show detailed review
            const reviewContainer = document.getElementById('test-review-details');
            reviewContainer.innerHTML = '';

            questions.forEach((question, index) => {
                const userAnswer = answers[index];
                const correctOption = question.options.find(opt => opt.correct);
                const userOption = question.options.find(opt => opt.label === userAnswer);
                const isCorrect = correctOption && userAnswer === correctOption.label;

                const reviewCard = document.createElement('div');
                reviewCard.className = `border-l-4 p-4 bg-white rounded-lg shadow-sm ${isCorrect ? 'border-green-500' : 'border-red-500'}`;
                
                reviewCard.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-bold text-gray-800">Question ${index + 1}</h4>
                        <span class="text-2xl">${isCorrect ? '‚úÖ' : '‚ùå'}</span>
                    </div>
                    <p class="text-gray-700 mb-3">${question.text}</p>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <strong class="text-gray-600">Your Answer:</strong><br>
                            <span class="${isCorrect ? 'text-green-600' : 'text-red-600'}">${userAnswer}. ${userOption?.text || 'Not answered'}</span>
                        </div>
                        <div>
                            <strong class="text-gray-600">Correct Answer:</strong><br>
                            <span class="text-green-600">${question.correctAnswer}</span>
                        </div>
                    </div>
                    ${question.explanationHTML ? `
                        <div class="mt-3 p-3 bg-blue-50 rounded-lg">
                            <strong class="text-blue-800">Explanation:</strong>
                            <div class="mt-2 explanation-content">${question.explanationHTML}</div>
                        </div>
                    ` : ''}
                `;
                
                reviewContainer.appendChild(reviewCard);
            });
        }

        function showNormalModeResults() {
            const accuracy = (correctCount + incorrectCount === 0) ? 0 : Math.round((correctCount / (correctCount + incorrectCount)) * 100);

            document.getElementById('quiz-section').classList.add('hidden');
            document.getElementById('final-results').classList.remove('hidden');

            document.getElementById('final-correct').textContent = correctCount;
            document.getElementById('final-incorrect').textContent = incorrectCount;
            document.getElementById('final-accuracy').textContent = `${accuracy}%`;

            let gradeIcon = 'üéØ';
            if (accuracy >= 90) {
                gradeIcon = 'üèÜ';
            } else if (accuracy >= 80) {
                gradeIcon = 'üéâ';
            } else if (accuracy >= 70) {
                gradeIcon = 'üëç';
            } else if (accuracy >= 60) {
                gradeIcon = 'üìö';
            } else {
                gradeIcon = 'üí™';
            }

            document.getElementById('final-grade-icon').textContent = gradeIcon;
        }
    </script>
</body>
</html>