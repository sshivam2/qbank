<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>27_Sexual Disorders and Sexual Abuse - Marrow Psychiatry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .medical-quiz {
            font-family: Segoe UI, Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .question-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .option-card {
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .option-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
        }
        
        .option-card.selected {
            background: #3b82f6;
            color: white;
            border-color: #1d4ed8;
        }
        
        .option-card.correct {
            background: #10b981;
            color: white;
            border-color: #059669;
        }
        
        .option-card.incorrect {
            background: #ef4444;
            color: white;
            border-color: #dc2626;
        }
        
        .progress-bar {
            background: linear-gradient(to right, #10b981, #059669);
            transition: width 0.3s;
        }
        
        .medical-image {
            max-width: 100%;
            max-height: 400px;
            height: auto;
            border-radius: 12px;
            margin: 20px auto;
            display: block;
        }
        
        .hidden {
            display: none !important;
        }

        .explanation-content {
            font-family: Segoe UI, Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1.05rem;
            line-height: 1.7;
            color: #374151;
            text-align: left;
        }
        
        .explanation-content p {
            margin-bottom: 1rem;
            text-align: justify;
        }
        
        .explanation-content strong, .explanation-content b {
            font-weight: 600;
            color: #1f2937;
        }
        
        .explanation-content img {
            max-width: 100%;
            height: auto;
            margin: 1.5rem auto;
            display: block;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen medical-quiz">
    <header class="bg-white shadow-xl p-6">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">27_Sexual Disorders and Sexual Abuse</h1>
                <p class="text-gray-600 mt-2">Marrow ‚Ä¢ Psychiatry ‚Ä¢ Interactive Learning</p>
            </div>
            <div class="flex gap-2">
                <button class="bg-gray-500 text-white px-3 py-2 text-sm rounded-lg hover:bg-gray-600 transition" 
                        onclick="window.location.href='marrow_psychiatry.html'">
                    ‚Üê Topics
                </button>
                <button class="bg-purple-500 text-white px-3 py-2 text-sm rounded-lg hover:bg-purple-600 transition" 
                        onclick="window.location.href='marrow.html'">
                    üìö Marrow
                </button>
                <button class="bg-blue-500 text-white px-3 py-2 text-sm rounded-lg hover:bg-blue-600 transition" 
                        onclick="window.location.href='index.html'">
                    üè† Home
                </button>
            </div>
        </div>
    </header>

    <!-- Statistics Bar (Hidden in Test Mode) -->
    <div class="bg-white shadow-lg p-4" id="stats-bar">
        <div class="container mx-auto flex justify-center gap-8">
            <div class="text-center">
                <div class="text-2xl font-bold text-green-600" id="correct-stats">0</div>
                <div class="text-sm text-gray-600">Correct</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-red-600" id="incorrect-stats">0</div>
                <div class="text-sm text-gray-600">Incorrect</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-blue-600" id="accuracy-stats">0%</div>
                <div class="text-sm text-gray-600">Accuracy</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-purple-600" id="progress-stats">0/8</div>
                <div class="text-sm text-gray-600">Progress</div>
            </div>
        </div>
    </div>

    <!-- Quiz Section -->
    <section class="container mx-auto p-6" id="quiz-section">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <!-- Progress Bar -->
            <div class="w-full bg-gray-200 rounded-full h-4 mb-8">
                <div class="progress-bar h-4 rounded-full" id="progress-bar"></div>
            </div>

            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold text-blue-700" id="question-number">Question 1 of 8</h2>
                <div class="text-sm text-gray-600" id="question-status">Click an option to answer</div>
            </div>

            <!-- Question Text -->
            <div class="mb-10">
                <div class="question-card text-white p-8 rounded-2xl mb-8" id="question-text"></div>
                
                <!-- Question Image -->
                <div class="text-center mb-8" id="question-images"></div>
                
                <!-- Options -->
                <div class="space-y-4" id="options"></div>
            </div>

            <!-- Answer Feedback Section (Normal Mode Only) -->
            <div class="hidden mb-8 p-6 rounded-2xl" id="feedback-section">
                <div class="text-center mb-4">
                    <div class="text-6xl mb-2" id="feedback-icon"></div>
                    <div class="text-2xl font-bold mb-2" id="feedback-message">Correct!</div>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div class="bg-white p-4 rounded-xl border">
                        <strong>Your Answer:</strong><br>
                        <span id="user-answer-display"></span>
                    </div>
                    <div class="bg-white p-4 rounded-xl border">
                        <strong>Correct Answer:</strong><br>
                        <span class="text-green-600" id="correct-answer-display"></span>
                    </div>
                </div>
                
                <div class="bg-blue-50 p-6 rounded-xl" id="explanation-section">
                    <strong class="text-lg text-blue-800">Explanation:</strong>
                    <div id="explanation-content" class="mt-3 explanation-content"></div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="flex justify-between gap-4">
                <button class="bg-gray-400 text-white px-6 py-3 rounded-xl hover:bg-gray-500 transition" 
                        onclick="window.location.href='marrow_psychiatry.html'">
                    Back to Topics
                </button>
                
                <div class="flex gap-4">
                    <button class="bg-gray-400 text-white px-6 py-3 rounded-xl disabled" id="prev-btn">
                        Previous
                    </button>
                    <button class="bg-blue-500 text-white px-6 py-3 rounded-xl hidden" id="next-btn">
                        Next
                    </button>
                    <button class="bg-green-600 text-white px-6 py-3 rounded-xl font-bold hidden" id="finish-btn">
                        Finish Quiz
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Test Mode Final Results -->
    <section class="container mx-auto p-6 hidden" id="test-results">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <div class="text-center mb-8">
                <h2 class="text-4xl font-bold mb-4 text-blue-700">Test Complete! üéâ</h2>
                <div class="text-6xl mb-4" id="test-grade-icon">üéØ</div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-green-100 p-6 rounded-2xl text-center">
                    <div class="text-4xl font-bold text-green-600" id="test-final-correct">0</div>
                    <div class="font-semibold text-green-700">Correct Answers</div>
                </div>
                <div class="bg-red-100 p-6 rounded-2xl text-center">
                    <div class="text-4xl font-bold text-red-600" id="test-final-incorrect">0</div>
                    <div class="font-semibold text-red-700">Incorrect Answers</div>
                </div>
                <div class="bg-blue-100 p-6 rounded-2xl text-center">
                    <div class="text-4xl font-bold text-blue-600" id="test-final-accuracy">0%</div>
                    <div class="font-semibold text-blue-700">Final Accuracy</div>
                </div>
            </div>

            <!-- Detailed Review -->
            <div class="mb-8">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">üìã Detailed Review</h3>
                <div id="test-review-details" class="space-y-4"></div>
            </div>
            
            <div class="flex justify-center gap-4">
                <button class="bg-purple-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-purple-700 transition" 
                        onclick="window.location.href='marrow_psychiatry.html'">
                    Back to Topics
                </button>
                <button class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-700 transition" 
                        onclick="window.location.reload()">
                    Retake Quiz
                </button>
            </div>
        </div>
    </section>

    <!-- Normal Mode Final Results -->
    <section class="container mx-auto p-6 hidden" id="final-results">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <div class="text-center mb-8">
                <h2 class="text-4xl font-bold mb-4 text-blue-700">Quiz Complete! üéâ</h2>
                <div class="text-6xl mb-4" id="final-grade-icon">üéØ</div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-green-100 p-6 rounded-2xl text-center">
                    <div class="text-4xl font-bold text-green-600" id="final-correct">0</div>
                    <div class="font-semibold text-green-700">Correct Answers</div>
                </div>
                <div class="bg-red-100 p-6 rounded-2xl text-center">
                    <div class="text-4xl font-bold text-red-600" id="final-incorrect">0</div>
                    <div class="font-semibold text-red-700">Incorrect Answers</div>
                </div>
                <div class="bg-blue-100 p-6 rounded-2xl text-center">
                    <div class="text-4xl font-bold text-blue-600" id="final-accuracy">0%</div>
                    <div class="font-semibold text-blue-700">Final Accuracy</div>
                </div>
            </div>
            
            <div class="flex justify-center gap-4">
                <button class="bg-purple-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-purple-700 transition" 
                        onclick="window.location.href='marrow_psychiatry.html'">
                    Back to Topics
                </button>
                <button class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-700 transition" 
                        onclick="window.location.reload()">
                    Retake Quiz
                </button>
            </div>
        </div>
    </section>

    <script>
        const questions = [
  {
    "id": 369,
    "text": "Q1. Crossing over from one behavior to another is a feature of which of the following?",
    "options": [
      {
        "label": "A",
        "text": "Paraphilia",
        "correct": true
      },
      {
        "label": "B",
        "text": "Gender dysphoria",
        "correct": false
      },
      {
        "label": "C",
        "text": "Satyriasis",
        "correct": false
      },
      {
        "label": "D",
        "text": "Nymphomania",
        "correct": false
      }
    ],
    "imageData": null,
    "explanationHTML": "<div class=\"explanation\">Crossing over from one behavior to another is seen in paraphilia. For example, paraphilic persons primarily involved with actual touching of victims (frottage, rape, and pedophilia) had previously been involved in paraphilic acts not involving touching of the victim (voyeurism and exhibitionism). Paraphiliacs tend to cross over between touching and nontouching of their victims, between family and nonfamily members, between female and male victims, and to victims of various ages. Gender incongruence is characterized by a marked and persistent incongruence between an individual's experienced gender and the assigned sex. This often leads to a desire to undergo hormonal treatment, surgery, or other health care services to make the individual's body align with the experienced gender. Satyriasis is a sexual paraphilia where a male is affected with insatiable sexual desire. The same, when seen in a female, is called nymphomania.</div><div class=\"telegram-link\"><small><a href=\"http://t.me/Friendly_neighborhood_medico_bot\"> </a></small></div>",
    "subdeck": "27_Sexual Disorders and Sexual Abuse",
    "deck_id": 1755954606932,
    "correctAnswer": "A. Paraphilia"
  },
  {
    "id": 370,
    "text": "Q2. Which of the following is not a paraphilia?",
    "options": [
      {
        "label": "A",
        "text": "Voyeurism",
        "correct": false
      },
      {
        "label": "B",
        "text": "Sexual sadism",
        "correct": false
      },
      {
        "label": "C",
        "text": "Homosexuality",
        "correct": true
      },
      {
        "label": "D",
        "text": "Pedophilia",
        "correct": false
      }
    ],
    "imageData": null,
    "explanationHTML": "<div class=\"explanation\">The term paraphilia does not include homosexuality. It is considered to be a normal variant of human sexuality. Paraphilia is defined as any intense and persistent sexual interest other than genital stimulation or fondling with normal, physically mature, consenting human partners.</div><div class=\"telegram-link\"><small><a href=\"http://t.me/Friendly_neighborhood_medico_bot\"> </a></small></div>",
    "subdeck": "27_Sexual Disorders and Sexual Abuse",
    "deck_id": 1755954606932,
    "correctAnswer": "C. Homosexuality"
  },
  {
    "id": 371,
    "text": "Q3. 23-year-old man who says he always felt like a woman, got his genitals surgically modified corresponding to female anatomy. What is this called?",
    "options": [
      {
        "label": "A",
        "text": "Transvestism",
        "correct": false
      },
      {
        "label": "B",
        "text": "Body dysmorphic disorder",
        "correct": false
      },
      {
        "label": "C",
        "text": "Gender incongruence",
        "correct": true
      },
      {
        "label": "D",
        "text": "Gender-queer",
        "correct": false
      }
    ],
    "imageData": null,
    "explanationHTML": "<div class=\"explanation\">Gender Incongruence of Adolescence and Adulthood (ICD-11) is characterized by a marked and persistent incongruence between an individual‚Äôs experienced gender and the assigned sex. This often leads to a desire to ‚Äòtransition‚Äô through hormonal treatment, surgery, or other health care services to make the individual‚Äôs body align with the experienced gender. The diagnosis cannot be assigned prior to the onset of puberty. Option A: Transvestism is described as fantasies and sexual urges to dress in opposite gender clothing as a means of arousal and as an adjunct to masturbation or coitus. Option B: Body dysmorphic disorder - persons wish to alter or remove a specific body part that they perceive to be unattractive. Option D: Gender-queer - people who feel they are in between two genders, or of neither gender. Note: The diagnosis of transsexualism was renamed in ICD-11 as gender incongruence, and moved from the chapter on Mental and Behavioral Disorders to the Conditions Related to Sexual Health. According to DSM-5 it has now been replaced with the term gender dysphoria. 312</div><div class=\"telegram-link\"><small><a href=\"http://t.me/Friendly_neighborhood_medico_bot\"> </a></small></div>",
    "subdeck": "27_Sexual Disorders and Sexual Abuse",
    "deck_id": 1755954606932,
    "correctAnswer": "C. Gender incongruence"
  },
  {
    "id": 372,
    "text": "Q4. Which of the following is false regarding exhibitionistic disorder?",
    "options": [
      {
        "label": "A",
        "text": "Punishable with imprisonment up to 3 months",
        "correct": false
      },
      {
        "label": "B",
        "text": "Diagnosed if persisting for a period of at least 3 months 309",
        "correct": true
      },
      {
        "label": "C",
        "text": "Causes significant distress or social impairment",
        "correct": false
      },
      {
        "label": "D",
        "text": "More common in males",
        "correct": false
      }
    ],
    "imageData": null,
    "explanationHTML": "<div class=\"explanation\">Exhibitionistic disorder, also known as flashing or indecent exposure, is diagnosed when such behaviors last for a period of 6 months or more. In exhibitionistic disorder, there is recurrent and intense sexual arousal from the exposure of one‚Äôs genitals to an unsuspecting individual in public places. This can also cause clinically significant distress or impairment of the person's social or occupational functioning. It is more common in males and the peak age of onset is in the 20s. This is a punishable offence (Section 294 IPC/ Section 296 BNS) with imprisonment up to 3 months or fine.</div><div class=\"telegram-link\"><small><a href=\"http://t.me/Friendly_neighborhood_medico_bot\"> </a></small></div>",
    "subdeck": "27_Sexual Disorders and Sexual Abuse",
    "deck_id": 1755954606932,
    "correctAnswer": "B. Diagnosed if persisting for a period of at least 3 months 309"
  },
  {
    "id": 373,
    "text": "Q5. What should be the minimum age to diagnose a patient with pedophilic disorder?",
    "options": [
      {
        "label": "A",
        "text": "14 years old",
        "correct": false
      },
      {
        "label": "B",
        "text": "16 years old",
        "correct": true
      },
      {
        "label": "C",
        "text": "18 years old",
        "correct": false
      },
      {
        "label": "D",
        "text": "No minimum age",
        "correct": false
      }
    ],
    "imageData": null,
    "explanationHTML": "<div class=\"explanation\">The individual should be at least 16 years of age to diagnose the pedophilic disorder. DSM-5 and ICD-11 criteria for pedophilic disorder: * Recurrent, intense sexually arousing fantasies, or behaviors involving sexual activity with a prepubescent child or children (generally age 13 years or younger) * The individual is at least 16 years of age and at least 5 years older than the child or children. * Persists over a period of at least 6 months. ¬¢ The individual must have acted on these thoughts, fantasies, or urges or be markedly distressed by them.</div><div class=\"telegram-link\"><small><a href=\"http://t.me/Friendly_neighborhood_medico_bot\"> </a></small></div>",
    "subdeck": "27_Sexual Disorders and Sexual Abuse",
    "deck_id": 1755954606932,
    "correctAnswer": "B. 16 years old"
  },
  {
    "id": 374,
    "text": "Q6. 24-year-old, who was assigned as female at birth, presented with a history of strong desire to be a male right from her childhood. She has always dressed like a boy and constantly feels that she is trapped in the wrong body. She is now in a relationship with a girl, which she considers to be a heterosexual relationship. What is the likely diagnosis?",
    "options": [
      {
        "label": "A",
        "text": "Hermaphroditism",
        "correct": false
      },
      {
        "label": "B",
        "text": "Transvestism",
        "correct": false
      },
      {
        "label": "C",
        "text": "Body dysmorphic disorder",
        "correct": false
      },
      {
        "label": "D",
        "text": "Gender dysphoria",
        "correct": true
      }
    ],
    "imageData": null,
    "explanationHTML": "<div class=\"explanation\">In the scenario, the patient has a marked incongruence between the experienced gender and natal gender (gender assigned at birth). This is called gender dysphoria in adolescents and adults (as per DSM-5) and is manifested by: * Unhappiness or a sense of inappropriateness with one‚Äôs natal sex * Strong desire to get rid of the natal gender‚Äôs primary and/or secondary sex characteristics ¬¢ Strong desire for primary and/or secondary sex characteristics of the other gender ¬¢ Strong feeling that one‚Äôs feelings and reactions are more typical of the other gender * Desire to be treated by others as a member of the opposite gender Note: ICD-11 uses the term gender incongruence to describe gender dysphoria (DSM-5).</div><div class=\"telegram-link\"><small><a href=\"http://t.me/Friendly_neighborhood_medico_bot\"> </a></small></div>",
    "subdeck": "27_Sexual Disorders and Sexual Abuse",
    "deck_id": 1755954606932,
    "correctAnswer": "D. Gender dysphoria"
  },
  {
    "id": 375,
    "text": "Q7. man is arrested by the police after multiple FIRs were registered against him for rubbing his genitals against women inappropriately in public transport. On questioning, the man says that he gets sexual gratification this way. Which of the following paraphilias describes this behavior?",
    "options": [
      {
        "label": "A",
        "text": "Voyeurism",
        "correct": false
      },
      {
        "label": "B",
        "text": "Fetishism",
        "correct": false
      },
      {
        "label": "C",
        "text": "Frotteurism",
        "correct": true
      },
      {
        "label": "D",
        "text": "Exhibitionism",
        "correct": false
      }
    ],
    "imageData": null,
    "explanationHTML": "<div class=\"explanation\">313 The given scenario is suggestive of frotteurism. It refers to the sexual gratification obtained by touching or rubbing against a non-consenting person. This behavior often occurs in busy, crowded places, such as on busy streets or on crowded buses or subways. It is predominantly described in men. A frotteur may fantasize that the woman he is rubbing up against is mutually aroused by the behavior.</div><div class=\"telegram-link\"><small><a href=\"http://t.me/Friendly_neighborhood_medico_bot\"> </a></small></div>",
    "subdeck": "27_Sexual Disorders and Sexual Abuse",
    "deck_id": 1755954606932,
    "correctAnswer": "C. Frotteurism"
  },
  {
    "id": 376,
    "text": "Q8. 310",
    "options": [
      {
        "label": "A",
        "text": "man who was caught peeking into his neighbor&apos;s intimate moments was served a restraining order. On evaluation, he is found to be a case of scopophilia. According to DSM-5, what is the minimum age at which this condition can be diagnosed? 14 years",
        "correct": false
      },
      {
        "label": "B",
        "text": "16 years",
        "correct": false
      },
      {
        "label": "C",
        "text": "18 years",
        "correct": true
      },
      {
        "label": "D",
        "text": "No age limit",
        "correct": false
      }
    ],
    "imageData": null,
    "explanationHTML": "<div class=\"explanation\">The given scenario is scopophilia, also known as voyeuristic disorder. The individual must be at least 18 years old for making this diagnosis. Criteria for the diagnosis of voyeuristic disorder (scopophilia) according to DSM-5: * Sexual gratification from observing an individual who is undressing, naked, or engaging in sexual activity * Persisting for at least 6-months * At least 18 years old * Significant distress or impairment in functioning</div><div class=\"telegram-link\"><small><a href=\"http://t.me/Friendly_neighborhood_medico_bot\"> </a></small></div>",
    "subdeck": "27_Sexual Disorders and Sexual Abuse",
    "deck_id": 1755954606932,
    "correctAnswer": "C. 18 years"
  }
];
        let currentQuestion = 0;
        let answers = [];
        let correctCount = 0;
        let incorrectCount = 0;
        let answeredQuestions = new Set();
        let isTestMode = localStorage.getItem('testMode') === 'true' || false;

        console.log('Quiz loaded with', questions.length, 'questions');
        console.log('Test mode:', isTestMode);

        // Hide stats bar if test mode is enabled
        if (isTestMode) {
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('stats-bar').style.display = 'none';
            });
        }

        // Auto-start quiz
        startQuiz();

        function startQuiz() {
            answers = new Array(questions.length).fill(null);
            correctCount = 0;
            incorrectCount = 0;
            answeredQuestions = new Set();
            currentQuestion = 0;
            showQuestion(0);
            updateStats();
        }

        function showQuestion(index) {
            currentQuestion = index;
            const question = questions[index];

            document.getElementById('question-number').textContent = `Question ${index + 1} of ${questions.length}`;
            document.getElementById('question-text').innerHTML = question.text;
            document.getElementById('question-status').textContent = answers[index] ? 'Question answered' : 'Click an option to answer';

            const imagesContainer = document.getElementById('question-images');
            imagesContainer.innerHTML = '';

            if (question.imageData) {
                const img = document.createElement('img');
                img.src = `data:${question.imageData.mime};base64,${question.imageData.data}`;
                img.className = 'medical-image';
                img.alt = 'Medical Question Image';
                imagesContainer.appendChild(img);
            }

            const optionsContainer = document.getElementById('options');
            optionsContainer.innerHTML = '';

            question.options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-card w-full p-6 text-left bg-white rounded-xl shadow-lg';
                button.innerHTML = `<span class="font-bold text-blue-600 mr-4">${option.label}.</span>${option.text}`;

                if (!isTestMode && answers[index] !== null) {
                    button.disabled = true;
                    if (option.correct) {
                        button.classList.add('correct');
                    } else if (answers[index] === option.label) {
                        button.classList.add('incorrect');
                    }
                } else {
                    button.onclick = () => selectAnswer(option.label);
                }

                if (answers[index] === option.label) {
                    button.classList.add('selected');
                }

                optionsContainer.appendChild(button);
            });

            // Show feedback only in normal mode and if answered
            if (!isTestMode && answers[index] !== null) {
                showFeedback(index);
            } else {
                document.getElementById('feedback-section').classList.add('hidden');
            }

            document.getElementById('prev-btn').disabled = index === 0;

            if (answers[index] !== null) {
                if (index === questions.length - 1) {
                    document.getElementById('next-btn').classList.add('hidden');
                    document.getElementById('finish-btn').classList.remove('hidden');
                } else {
                    document.getElementById('next-btn').classList.remove('hidden');
                    document.getElementById('finish-btn').classList.add('hidden');
                }
            } else {
                document.getElementById('next-btn').classList.add('hidden');
                document.getElementById('finish-btn').classList.add('hidden');
            }

            const progress = ((index + 1) / questions.length) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
        }

        function selectAnswer(label) {
            const question = questions[currentQuestion];
            const correctOption = question.options.find(opt => opt.correct);
            const isCorrect = correctOption && label === correctOption.label;

            if (!answeredQuestions.has(currentQuestion)) {
                answeredQuestions.add(currentQuestion);
                if (isCorrect) {
                    correctCount++;
                } else {
                    incorrectCount++;
                }
            }

            answers[currentQuestion] = label;
            updateStats();
            
            showQuestion(currentQuestion);
        }

        function showFeedback(questionIndex) {
            const question = questions[questionIndex];
            const userAnswer = answers[questionIndex];
            const correctOption = question.options.find(opt => opt.correct);
            const userOption = question.options.find(opt => opt.label === userAnswer);
            const isCorrect = correctOption && userAnswer === correctOption.label;

            const feedbackSection = document.getElementById('feedback-section');
            const feedbackIcon = document.getElementById('feedback-icon');
            const feedbackMessage = document.getElementById('feedback-message');

            if (isCorrect) {
                feedbackSection.className = 'bg-green-50 border border-green-200 mb-8 p-6 rounded-2xl';
                feedbackIcon.textContent = '‚úÖ';
                feedbackMessage.textContent = 'Correct!';
                feedbackMessage.className = 'text-2xl font-bold mb-2 text-green-700';
            } else {
                feedbackSection.className = 'bg-red-50 border border-red-200 mb-8 p-6 rounded-2xl';
                feedbackIcon.textContent = '‚ùå';
                feedbackMessage.textContent = 'Incorrect';
                feedbackMessage.className = 'text-2xl font-bold mb-2 text-red-700';
            }

            document.getElementById('user-answer-display').innerHTML = `<span class="${isCorrect ? 'text-green-600' : 'text-red-600'}">${userAnswer}. ${userOption?.text || 'Unknown'}</span>`;
            document.getElementById('correct-answer-display').textContent = question.correctAnswer;

            const explanationSection = document.getElementById('explanation-section');
            if (question.explanationHTML && question.explanationHTML.trim()) {
                document.getElementById('explanation-content').innerHTML = question.explanationHTML;
                explanationSection.classList.remove('hidden');
            } else {
                explanationSection.classList.add('hidden');
            }

            feedbackSection.classList.remove('hidden');
        }

        function updateStats() {
            const totalAnswered = correctCount + incorrectCount;
            const accuracy = totalAnswered === 0 ? 0 : Math.round((correctCount / totalAnswered) * 100);

            document.getElementById('correct-stats').textContent = correctCount;
            document.getElementById('incorrect-stats').textContent = incorrectCount;
            document.getElementById('accuracy-stats').textContent = `${accuracy}%`;
            document.getElementById('progress-stats').textContent = `${totalAnswered}/${questions.length}`;
        }

        document.getElementById('prev-btn').onclick = () => {
            if (currentQuestion > 0) {
                showQuestion(currentQuestion - 1);
            }
        };
        
        document.getElementById('next-btn').onclick = () => {
            if (currentQuestion < questions.length - 1) {
                showQuestion(currentQuestion + 1);
            }
        };
        
        document.getElementById('finish-btn').onclick = showFinalResults;

        function showFinalResults() {
            if (isTestMode) {
                showTestModeResults();
            } else {
                showNormalModeResults();
            }
        }

        function showTestModeResults() {
            const accuracy = (correctCount + incorrectCount === 0) ? 0 : Math.round((correctCount / (correctCount + incorrectCount)) * 100);

            document.getElementById('quiz-section').classList.add('hidden');
            document.getElementById('test-results').classList.remove('hidden');

            document.getElementById('test-final-correct').textContent = correctCount;
            document.getElementById('test-final-incorrect').textContent = incorrectCount;
            document.getElementById('test-final-accuracy').textContent = `${accuracy}%`;

            let gradeIcon = 'üéØ';
            if (accuracy >= 90) {
                gradeIcon = 'üèÜ';
            } else if (accuracy >= 80) {
                gradeIcon = 'üéâ';
            } else if (accuracy >= 70) {
                gradeIcon = 'üëç';
            } else if (accuracy >= 60) {
                gradeIcon = 'üìö';
            } else {
                gradeIcon = 'üí™';
            }

            document.getElementById('test-grade-icon').textContent = gradeIcon;

            // Show detailed review
            const reviewContainer = document.getElementById('test-review-details');
            reviewContainer.innerHTML = '';

            questions.forEach((question, index) => {
                const userAnswer = answers[index];
                const correctOption = question.options.find(opt => opt.correct);
                const userOption = question.options.find(opt => opt.label === userAnswer);
                const isCorrect = correctOption && userAnswer === correctOption.label;

                const reviewCard = document.createElement('div');
                reviewCard.className = `border-l-4 p-4 bg-white rounded-lg shadow-sm ${isCorrect ? 'border-green-500' : 'border-red-500'}`;
                
                reviewCard.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-bold text-gray-800">Question ${index + 1}</h4>
                        <span class="text-2xl">${isCorrect ? '‚úÖ' : '‚ùå'}</span>
                    </div>
                    <p class="text-gray-700 mb-3">${question.text}</p>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <strong class="text-gray-600">Your Answer:</strong><br>
                            <span class="${isCorrect ? 'text-green-600' : 'text-red-600'}">${userAnswer}. ${userOption?.text || 'Not answered'}</span>
                        </div>
                        <div>
                            <strong class="text-gray-600">Correct Answer:</strong><br>
                            <span class="text-green-600">${question.correctAnswer}</span>
                        </div>
                    </div>
                    ${question.explanationHTML ? `
                        <div class="mt-3 p-3 bg-blue-50 rounded-lg">
                            <strong class="text-blue-800">Explanation:</strong>
                            <div class="mt-2 explanation-content">${question.explanationHTML}</div>
                        </div>
                    ` : ''}
                `;
                
                reviewContainer.appendChild(reviewCard);
            });
        }

        function showNormalModeResults() {
            const accuracy = (correctCount + incorrectCount === 0) ? 0 : Math.round((correctCount / (correctCount + incorrectCount)) * 100);

            document.getElementById('quiz-section').classList.add('hidden');
            document.getElementById('final-results').classList.remove('hidden');

            document.getElementById('final-correct').textContent = correctCount;
            document.getElementById('final-incorrect').textContent = incorrectCount;
            document.getElementById('final-accuracy').textContent = `${accuracy}%`;

            let gradeIcon = 'üéØ';
            if (accuracy >= 90) {
                gradeIcon = 'üèÜ';
            } else if (accuracy >= 80) {
                gradeIcon = 'üéâ';
            } else if (accuracy >= 70) {
                gradeIcon = 'üëç';
            } else if (accuracy >= 60) {
                gradeIcon = 'üìö';
            } else {
                gradeIcon = 'üí™';
            }

            document.getElementById('final-grade-icon').textContent = gradeIcon;
        }
    </script>
</body>
</html>