<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>33_Forensic Psychiatry - Marrow Psychiatry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .medical-quiz {
            font-family: Segoe UI, Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .question-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .option-card {
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .option-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
        }
        
        .option-card.selected {
            background: #3b82f6;
            color: white;
            border-color: #1d4ed8;
        }
        
        .option-card.correct {
            background: #10b981;
            color: white;
            border-color: #059669;
        }
        
        .option-card.incorrect {
            background: #ef4444;
            color: white;
            border-color: #dc2626;
        }
        
        .progress-bar {
            background: linear-gradient(to right, #10b981, #059669);
            transition: width 0.3s;
        }
        
        .medical-image {
            max-width: 100%;
            max-height: 400px;
            height: auto;
            border-radius: 12px;
            margin: 20px auto;
            display: block;
        }
        
        .hidden {
            display: none !important;
        }

        .explanation-content {
            font-family: Segoe UI, Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1.05rem;
            line-height: 1.7;
            color: #374151;
            text-align: left;
        }
        
        .explanation-content p {
            margin-bottom: 1rem;
            text-align: justify;
        }
        
        .explanation-content strong, .explanation-content b {
            font-weight: 600;
            color: #1f2937;
        }
        
        .explanation-content img {
            max-width: 100%;
            height: auto;
            margin: 1.5rem auto;
            display: block;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen medical-quiz">
    <header class="bg-white shadow-xl p-6">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">33_Forensic Psychiatry</h1>
                <p class="text-gray-600 mt-2">Marrow ‚Ä¢ Psychiatry ‚Ä¢ Interactive Learning</p>
            </div>
            <div class="flex gap-2">
                <button class="bg-gray-500 text-white px-3 py-2 text-sm rounded-lg hover:bg-gray-600 transition" 
                        onclick="window.location.href='marrow_psychiatry.html'">
                    ‚Üê Topics
                </button>
                <button class="bg-purple-500 text-white px-3 py-2 text-sm rounded-lg hover:bg-purple-600 transition" 
                        onclick="window.location.href='marrow.html'">
                    üìö Marrow
                </button>
                <button class="bg-blue-500 text-white px-3 py-2 text-sm rounded-lg hover:bg-blue-600 transition" 
                        onclick="window.location.href='index.html'">
                    üè† Home
                </button>
            </div>
        </div>
    </header>

    <!-- Statistics Bar (Hidden in Test Mode) -->
    <div class="bg-white shadow-lg p-4" id="stats-bar">
        <div class="container mx-auto flex justify-center gap-8">
            <div class="text-center">
                <div class="text-2xl font-bold text-green-600" id="correct-stats">0</div>
                <div class="text-sm text-gray-600">Correct</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-red-600" id="incorrect-stats">0</div>
                <div class="text-sm text-gray-600">Incorrect</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-blue-600" id="accuracy-stats">0%</div>
                <div class="text-sm text-gray-600">Accuracy</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-purple-600" id="progress-stats">0/7</div>
                <div class="text-sm text-gray-600">Progress</div>
            </div>
        </div>
    </div>

    <!-- Quiz Section -->
    <section class="container mx-auto p-6" id="quiz-section">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <!-- Progress Bar -->
            <div class="w-full bg-gray-200 rounded-full h-4 mb-8">
                <div class="progress-bar h-4 rounded-full" id="progress-bar"></div>
            </div>

            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold text-blue-700" id="question-number">Question 1 of 7</h2>
                <div class="text-sm text-gray-600" id="question-status">Click an option to answer</div>
            </div>

            <!-- Question Text -->
            <div class="mb-10">
                <div class="question-card text-white p-8 rounded-2xl mb-8" id="question-text"></div>
                
                <!-- Question Image -->
                <div class="text-center mb-8" id="question-images"></div>
                
                <!-- Options -->
                <div class="space-y-4" id="options"></div>
            </div>

            <!-- Answer Feedback Section (Normal Mode Only) -->
            <div class="hidden mb-8 p-6 rounded-2xl" id="feedback-section">
                <div class="text-center mb-4">
                    <div class="text-6xl mb-2" id="feedback-icon"></div>
                    <div class="text-2xl font-bold mb-2" id="feedback-message">Correct!</div>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div class="bg-white p-4 rounded-xl border">
                        <strong>Your Answer:</strong><br>
                        <span id="user-answer-display"></span>
                    </div>
                    <div class="bg-white p-4 rounded-xl border">
                        <strong>Correct Answer:</strong><br>
                        <span class="text-green-600" id="correct-answer-display"></span>
                    </div>
                </div>
                
                <div class="bg-blue-50 p-6 rounded-xl" id="explanation-section">
                    <strong class="text-lg text-blue-800">Explanation:</strong>
                    <div id="explanation-content" class="mt-3 explanation-content"></div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="flex justify-between gap-4">
                <button class="bg-gray-400 text-white px-6 py-3 rounded-xl hover:bg-gray-500 transition" 
                        onclick="window.location.href='marrow_psychiatry.html'">
                    Back to Topics
                </button>
                
                <div class="flex gap-4">
                    <button class="bg-gray-400 text-white px-6 py-3 rounded-xl disabled" id="prev-btn">
                        Previous
                    </button>
                    <button class="bg-blue-500 text-white px-6 py-3 rounded-xl hidden" id="next-btn">
                        Next
                    </button>
                    <button class="bg-green-600 text-white px-6 py-3 rounded-xl font-bold hidden" id="finish-btn">
                        Finish Quiz
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Test Mode Final Results -->
    <section class="container mx-auto p-6 hidden" id="test-results">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <div class="text-center mb-8">
                <h2 class="text-4xl font-bold mb-4 text-blue-700">Test Complete! üéâ</h2>
                <div class="text-6xl mb-4" id="test-grade-icon">üéØ</div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-green-100 p-6 rounded-2xl text-center">
                    <div class="text-4xl font-bold text-green-600" id="test-final-correct">0</div>
                    <div class="font-semibold text-green-700">Correct Answers</div>
                </div>
                <div class="bg-red-100 p-6 rounded-2xl text-center">
                    <div class="text-4xl font-bold text-red-600" id="test-final-incorrect">0</div>
                    <div class="font-semibold text-red-700">Incorrect Answers</div>
                </div>
                <div class="bg-blue-100 p-6 rounded-2xl text-center">
                    <div class="text-4xl font-bold text-blue-600" id="test-final-accuracy">0%</div>
                    <div class="font-semibold text-blue-700">Final Accuracy</div>
                </div>
            </div>

            <!-- Detailed Review -->
            <div class="mb-8">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">üìã Detailed Review</h3>
                <div id="test-review-details" class="space-y-4"></div>
            </div>
            
            <div class="flex justify-center gap-4">
                <button class="bg-purple-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-purple-700 transition" 
                        onclick="window.location.href='marrow_psychiatry.html'">
                    Back to Topics
                </button>
                <button class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-700 transition" 
                        onclick="window.location.reload()">
                    Retake Quiz
                </button>
            </div>
        </div>
    </section>

    <!-- Normal Mode Final Results -->
    <section class="container mx-auto p-6 hidden" id="final-results">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <div class="text-center mb-8">
                <h2 class="text-4xl font-bold mb-4 text-blue-700">Quiz Complete! üéâ</h2>
                <div class="text-6xl mb-4" id="final-grade-icon">üéØ</div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-green-100 p-6 rounded-2xl text-center">
                    <div class="text-4xl font-bold text-green-600" id="final-correct">0</div>
                    <div class="font-semibold text-green-700">Correct Answers</div>
                </div>
                <div class="bg-red-100 p-6 rounded-2xl text-center">
                    <div class="text-4xl font-bold text-red-600" id="final-incorrect">0</div>
                    <div class="font-semibold text-red-700">Incorrect Answers</div>
                </div>
                <div class="bg-blue-100 p-6 rounded-2xl text-center">
                    <div class="text-4xl font-bold text-blue-600" id="final-accuracy">0%</div>
                    <div class="font-semibold text-blue-700">Final Accuracy</div>
                </div>
            </div>
            
            <div class="flex justify-center gap-4">
                <button class="bg-purple-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-purple-700 transition" 
                        onclick="window.location.href='marrow_psychiatry.html'">
                    Back to Topics
                </button>
                <button class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-700 transition" 
                        onclick="window.location.reload()">
                    Retake Quiz
                </button>
            </div>
        </div>
    </section>

    <script>
        const questions = [
  {
    "id": 418,
    "text": "Q1. Under the Mental Health Care Act 2017, a patient has the right to choose his or her caretaker and future course of action in treatment. What is this provision known as?",
    "options": [
      {
        "label": "A",
        "text": "Treatment directive",
        "correct": false
      },
      {
        "label": "B",
        "text": "Mental will",
        "correct": false
      },
      {
        "label": "C",
        "text": "Future directive",
        "correct": false
      },
      {
        "label": "D",
        "text": "Advance directive",
        "correct": true
      }
    ],
    "imageData": null,
    "explanationHTML": "<div class=\"explanation\">The provision by which a patient has the right to choose his caretaker and future course of action in treatment because of illness or incapacity is known as an advance directive. It is also known as a living will, personal directive, or medical directive.</div><div class=\"telegram-link\"><small><a href=\"http://t.me/Friendly_neighborhood_medico_bot\"> </a></small></div>",
    "subdeck": "33_Forensic Psychiatry",
    "deck_id": 1755954606920,
    "correctAnswer": "D. Advance directive"
  },
  {
    "id": 419,
    "text": "Q2. Which of the following conditions are included under the Rights of Persons With Disabilities Act, 2016?",
    "options": [
      {
        "label": "A",
        "text": "Specific learning disability",
        "correct": false
      },
      {
        "label": "B",
        "text": "Mental illness",
        "correct": false
      },
      {
        "label": "C",
        "text": "Parkinson&apos;s disease",
        "correct": false
      },
      {
        "label": "D",
        "text": "All the above",
        "correct": true
      }
    ],
    "imageData": null,
    "explanationHTML": "<div class=\"explanation\">All of the above are considered for provisions under the Rights of Persons with Disabilities Act. There are 21 disabilities included: * Specific learning disability * Mental illness * Parkinson's disease * Intellectual disability ¬¢ Autism spectrum * Acid attack victims 352 * Blindness * Low-vision * Leprosy cured person * Hearing impairment (deaf and hard of hearing) * Locomotor disability * Dwarfism * Cerebral Palsy * Muscular Dystrophy * Chronic neurological conditions * Multiple Sclerosis * Speech and language disability * Thalassemia * Hemophilia * Sickle cell disease * Multiple disabilities including deaf-blindness The Indian disability evaluation and assessment scale (IDEAS) is used for measuring and quantifying disability in mental illnesses.</div><div class=\"telegram-link\"><small><a href=\"http://t.me/Friendly_neighborhood_medico_bot\"> </a></small></div>",
    "subdeck": "33_Forensic Psychiatry",
    "deck_id": 1755954606920,
    "correctAnswer": "D. All the above"
  },
  {
    "id": 420,
    "text": "Q4. Which of the following mentally ill persons will be exempted from all charges under Sec 84?",
    "options": [
      {
        "label": "A",
        "text": "1,2 and3",
        "correct": false
      },
      {
        "label": "B",
        "text": "2, 3 and 4 350",
        "correct": false
      },
      {
        "label": "C",
        "text": "3, 4 and 5 d)1,2and5",
        "correct": true
      },
      {
        "label": "D",
        "text": "",
        "correct": false
      }
    ],
    "imageData": null,
    "explanationHTML": "<div class=\"explanation\">The mentally ill in cases 3, 4, and 5 will be exempted according to M'Naghten's rule. In a court of law to prove criminal liability against an accused with mental illness both mens rea (a guilty mind) and actus rea (an illegal act) at the point of time should be present when the crime was committed. Case 3: The accused does not know the nature of his act and absence of motive or secrecy and shows unsoundness of mind in this case. Hence he is exempted. 353 Case 4: The delusion is judged as if it is real. The accused thought he was doing his job legally as the state executioner. Hence he is exempted. Case 5: Epilepsy, schizophrenia, and paranoia are exempted in the court of law from criminal liability. In this case, the patient was probably in post-ictal state, and mens rea was absent. Thus, in cases 3, 4, and 5, the accused are medically insane and legally insane. Case 1: The accused killed his children out of severe disturbance. However, as per the law, the disturbance is not considered to impair his thinking capacity. There was also no need for self-defense. Hence he would not be exempted. Case 2: The delusion is judged as if it is unreal (i. e. , there is no delusion), because the patient was deluded that the victim had killed his wife, but the motive to attempt the murder was out of revenge which is illegal and hence, the person is not exempted. Thus, in cases 1 and 2, the people are medically insane, but not legally insane.</div><div class=\"telegram-link\"><small><a href=\"http://t.me/Friendly_neighborhood_medico_bot\"> </a></small></div>",
    "subdeck": "33_Forensic Psychiatry",
    "deck_id": 1755954606920,
    "correctAnswer": "C. 3, 4 and 5 d)1,2and5"
  },
  {
    "id": 421,
    "text": "Q5. person suffering from which of the following conditions is criminally responsible?",
    "options": [
      {
        "label": "A",
        "text": "Kleptomania",
        "correct": true
      },
      {
        "label": "B",
        "text": "Somnambulism",
        "correct": false
      },
      {
        "label": "C",
        "text": "Oneroid state",
        "correct": false
      },
      {
        "label": "D",
        "text": "Delirium tremens",
        "correct": false
      }
    ],
    "imageData": null,
    "explanationHTML": "<div class=\"explanation\">A kleptomaniac is fully responsible for his crimes and is not exempted based on sec 84 IPC (McNaughten's rule), as McNaughten's rule in India considers only a defect of mind, reason, and intellectual capability. However, it does not consider emotions and control of impulses. Thus, a kleptomaniac is only mentally ill but not legally insane. The punishment for a kleptomaniac is given under the Doctrine of diminished responsibility. This absolves an accused person of part of the liability for his criminal act, as their mental functions were \"diminished\" or impaired at that time. A person is not criminally responsible during states where mens rea (guilty mind) is absent due to the unsoundness of the mind. The conditions for which this is applicable are: * Post-traumatic automatism * Somnambulism * Twilight state: Disordered consciousness during which actions may be performed unconsciously. * Oneroid State: dream-like disturbances of one's consciousness by hallucinations, accompanied by catatonic symptoms (either catatonic stupor or excitement) and delusions. * Delirium tremens</div><div class=\"telegram-link\"><small><a href=\"http://t.me/Friendly_neighborhood_medico_bot\"> </a></small></div>",
    "subdeck": "33_Forensic Psychiatry",
    "deck_id": 1755954606920,
    "correctAnswer": "A. Kleptomania"
  },
  {
    "id": 422,
    "text": "Q6. Which of the following is false?",
    "options": [
      {
        "label": "A",
        "text": "A person suffering from a somatic delusion has testamentary capacity",
        "correct": false
      },
      {
        "label": "B",
        "text": "A mentally ill person can give evidence during lucid interval",
        "correct": false
      },
      {
        "label": "C",
        "text": "A mentally ill person is not criminally responsible during lucid interval",
        "correct": true
      },
      {
        "label": "D",
        "text": "A person suffering from delusions of grandiosity cannot make a will",
        "correct": false
      }
    ],
    "imageData": null,
    "explanationHTML": "<div class=\"explanation\">A mentally ill person is indeed criminally responsible during the lucid interval. Lucid interval: The period of sanity or consciousness between two periods of insanity or unconsciousness. Seen in states like mania, melancholia, extradural hemorrhage. During this period, a mentally ill person: * Can give evidence. 354 * Is criminally responsible. * Has testamentary capacity. Testamentary capacity is the mental ability of a person to make a will. A person of a sound disposing mind at the time of making the will (not necessarily always) can make a will. A person suffering from an insane delusion can make a will if the delusion is not related in any way by the disposal of property or the persons affected. For example: * Delusion of grandeur: cannot make a will, as they believe they possess more than they actually do. * Delusion of persecution: might not be allowed to make a will, because it will affect who they distribute their property to. * Somatic delusions: can make a will. Only has delusions of physical symptoms, who they distribute their property to is not affected.</div><div class=\"telegram-link\"><small><a href=\"http://t.me/Friendly_neighborhood_medico_bot\"> </a></small></div>",
    "subdeck": "33_Forensic Psychiatry",
    "deck_id": 1755954606920,
    "correctAnswer": "C. A mentally ill person is not criminally responsible during lucid interval"
  },
  {
    "id": 423,
    "text": "Q7. In which of the following situations, can a marriage be declared null and void?",
    "options": [
      {
        "label": "A",
        "text": "If the partner&apos;s mental illness developed 6 months after marriage",
        "correct": false
      },
      {
        "label": "B",
        "text": "If the partner&apos;s mental illness was present only before the time of marriage",
        "correct": false
      },
      {
        "label": "C",
        "text": "If the partner&apos;s mental illness was present at the time of marriage",
        "correct": true
      },
      {
        "label": "D",
        "text": "All of the above",
        "correct": false
      }
    ],
    "imageData": null,
    "explanationHTML": "<div class=\"explanation\">If either person in the marriage is suffering from a mental illness at the time of marriage, only then can the marriage be declared null and void. The mental condition of both the parties at the time of marriage is taken for deciding nullification.</div><div class=\"telegram-link\"><small><a href=\"http://t.me/Friendly_neighborhood_medico_bot\"> </a></small></div>",
    "subdeck": "33_Forensic Psychiatry",
    "deck_id": 1755954606920,
    "correctAnswer": "C. If the partner&apos;s mental illness was present at the time of marriage"
  },
  {
    "id": 424,
    "text": "Q8. 37-year-old patient was admitted to a hospital independently for the treatment of depression. During the stay, the patient attempted to hurt themselves. According to the Mental Health Care Act, 2017, within how many hours should a repeat mental health assessment be carried out to reclassify the admission as a supported admission?",
    "options": [
      {
        "label": "A",
        "text": "48 hours 351 living will, personal directive, or medical directive. Solution to Question 2: All of the above are considered for provisions under the Rights of Persons with Disabilities Act. There are 21 disabilities included: * Specific learning disability * Mental illness * Parkinson&apos;s disease * Intellectual disability ¬¢ Autism spectrum * Acid attack victims 352",
        "correct": false
      },
      {
        "label": "B",
        "text": "72 hours",
        "correct": false
      },
      {
        "label": "C",
        "text": "24 hours",
        "correct": true
      },
      {
        "label": "D",
        "text": "36 hours ee ee ee rr ee ee ee ee ee ee Detailed Explanations Solution to Question 1: The provision by which a patient has the right to choose his caretaker and future course of action in treatment because of illness or incapacity is known as an advance directive. It is also known as",
        "correct": false
      }
    ],
    "imageData": null,
    "explanationHTML": "<div class=\"explanation\">According to the Mental Health Care Act of 2017, the patient should be re-examined within 24 hours to re-classify the admission as supported admission. Mental Health Care Act 2017 classifies admissions as independent and supported. * Independent admissions refers to the admission of a person with mental illness, to a mental health establishment, who can make mental healthcare and treatment decisions or requires minimal support in making decisions. ¬¢ Supported admissions refer to the admission and treatment of persons with mental illness, with high support needs, in mental health establishments. The medical officer or mental health professional must discharge any independently admitted patient immediately upon their request. However, under certain conditions, the discharge can be delayed for 24 hours to allow for an assessment necessary to reclassify the patient under the supported category. These conditions are: (a) the person is unable to understand the nature and purpose of their decisions and requires substantial or very high support from their nominated representative; or (b) the person has recently threatened or attempted or is threatening or attempting, to cause bodily harm to themselves; or (c) the person has recently behaved, or is behaving, violently towards another person or is causing another person to fear bodily harm; or 355</div><div class=\"telegram-link\"><small><a href=\"http://t.me/Friendly_neighborhood_medico_bot\"> </a></small></div>",
    "subdeck": "33_Forensic Psychiatry",
    "deck_id": 1755954606920,
    "correctAnswer": "C. 24 hours"
  }
];
        let currentQuestion = 0;
        let answers = [];
        let correctCount = 0;
        let incorrectCount = 0;
        let answeredQuestions = new Set();
        let isTestMode = localStorage.getItem('testMode') === 'true' || false;

        console.log('Quiz loaded with', questions.length, 'questions');
        console.log('Test mode:', isTestMode);

        // Hide stats bar if test mode is enabled
        if (isTestMode) {
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('stats-bar').style.display = 'none';
            });
        }

        // Auto-start quiz
        startQuiz();

        function startQuiz() {
            answers = new Array(questions.length).fill(null);
            correctCount = 0;
            incorrectCount = 0;
            answeredQuestions = new Set();
            currentQuestion = 0;
            showQuestion(0);
            updateStats();
        }

        function showQuestion(index) {
            currentQuestion = index;
            const question = questions[index];

            document.getElementById('question-number').textContent = `Question ${index + 1} of ${questions.length}`;
            document.getElementById('question-text').innerHTML = question.text;
            document.getElementById('question-status').textContent = answers[index] ? 'Question answered' : 'Click an option to answer';

            const imagesContainer = document.getElementById('question-images');
            imagesContainer.innerHTML = '';

            if (question.imageData) {
                const img = document.createElement('img');
                img.src = `data:${question.imageData.mime};base64,${question.imageData.data}`;
                img.className = 'medical-image';
                img.alt = 'Medical Question Image';
                imagesContainer.appendChild(img);
            }

            const optionsContainer = document.getElementById('options');
            optionsContainer.innerHTML = '';

            question.options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-card w-full p-6 text-left bg-white rounded-xl shadow-lg';
                button.innerHTML = `<span class="font-bold text-blue-600 mr-4">${option.label}.</span>${option.text}`;

                if (!isTestMode && answers[index] !== null) {
                    button.disabled = true;
                    if (option.correct) {
                        button.classList.add('correct');
                    } else if (answers[index] === option.label) {
                        button.classList.add('incorrect');
                    }
                } else {
                    button.onclick = () => selectAnswer(option.label);
                }

                if (answers[index] === option.label) {
                    button.classList.add('selected');
                }

                optionsContainer.appendChild(button);
            });

            // Show feedback only in normal mode and if answered
            if (!isTestMode && answers[index] !== null) {
                showFeedback(index);
            } else {
                document.getElementById('feedback-section').classList.add('hidden');
            }

            document.getElementById('prev-btn').disabled = index === 0;

            if (answers[index] !== null) {
                if (index === questions.length - 1) {
                    document.getElementById('next-btn').classList.add('hidden');
                    document.getElementById('finish-btn').classList.remove('hidden');
                } else {
                    document.getElementById('next-btn').classList.remove('hidden');
                    document.getElementById('finish-btn').classList.add('hidden');
                }
            } else {
                document.getElementById('next-btn').classList.add('hidden');
                document.getElementById('finish-btn').classList.add('hidden');
            }

            const progress = ((index + 1) / questions.length) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
        }

        function selectAnswer(label) {
            const question = questions[currentQuestion];
            const correctOption = question.options.find(opt => opt.correct);
            const isCorrect = correctOption && label === correctOption.label;

            if (!answeredQuestions.has(currentQuestion)) {
                answeredQuestions.add(currentQuestion);
                if (isCorrect) {
                    correctCount++;
                } else {
                    incorrectCount++;
                }
            }

            answers[currentQuestion] = label;
            updateStats();
            
            showQuestion(currentQuestion);
        }

        function showFeedback(questionIndex) {
            const question = questions[questionIndex];
            const userAnswer = answers[questionIndex];
            const correctOption = question.options.find(opt => opt.correct);
            const userOption = question.options.find(opt => opt.label === userAnswer);
            const isCorrect = correctOption && userAnswer === correctOption.label;

            const feedbackSection = document.getElementById('feedback-section');
            const feedbackIcon = document.getElementById('feedback-icon');
            const feedbackMessage = document.getElementById('feedback-message');

            if (isCorrect) {
                feedbackSection.className = 'bg-green-50 border border-green-200 mb-8 p-6 rounded-2xl';
                feedbackIcon.textContent = '‚úÖ';
                feedbackMessage.textContent = 'Correct!';
                feedbackMessage.className = 'text-2xl font-bold mb-2 text-green-700';
            } else {
                feedbackSection.className = 'bg-red-50 border border-red-200 mb-8 p-6 rounded-2xl';
                feedbackIcon.textContent = '‚ùå';
                feedbackMessage.textContent = 'Incorrect';
                feedbackMessage.className = 'text-2xl font-bold mb-2 text-red-700';
            }

            document.getElementById('user-answer-display').innerHTML = `<span class="${isCorrect ? 'text-green-600' : 'text-red-600'}">${userAnswer}. ${userOption?.text || 'Unknown'}</span>`;
            document.getElementById('correct-answer-display').textContent = question.correctAnswer;

            const explanationSection = document.getElementById('explanation-section');
            if (question.explanationHTML && question.explanationHTML.trim()) {
                document.getElementById('explanation-content').innerHTML = question.explanationHTML;
                explanationSection.classList.remove('hidden');
            } else {
                explanationSection.classList.add('hidden');
            }

            feedbackSection.classList.remove('hidden');
        }

        function updateStats() {
            const totalAnswered = correctCount + incorrectCount;
            const accuracy = totalAnswered === 0 ? 0 : Math.round((correctCount / totalAnswered) * 100);

            document.getElementById('correct-stats').textContent = correctCount;
            document.getElementById('incorrect-stats').textContent = incorrectCount;
            document.getElementById('accuracy-stats').textContent = `${accuracy}%`;
            document.getElementById('progress-stats').textContent = `${totalAnswered}/${questions.length}`;
        }

        document.getElementById('prev-btn').onclick = () => {
            if (currentQuestion > 0) {
                showQuestion(currentQuestion - 1);
            }
        };
        
        document.getElementById('next-btn').onclick = () => {
            if (currentQuestion < questions.length - 1) {
                showQuestion(currentQuestion + 1);
            }
        };
        
        document.getElementById('finish-btn').onclick = showFinalResults;

        function showFinalResults() {
            if (isTestMode) {
                showTestModeResults();
            } else {
                showNormalModeResults();
            }
        }

        function showTestModeResults() {
            const accuracy = (correctCount + incorrectCount === 0) ? 0 : Math.round((correctCount / (correctCount + incorrectCount)) * 100);

            document.getElementById('quiz-section').classList.add('hidden');
            document.getElementById('test-results').classList.remove('hidden');

            document.getElementById('test-final-correct').textContent = correctCount;
            document.getElementById('test-final-incorrect').textContent = incorrectCount;
            document.getElementById('test-final-accuracy').textContent = `${accuracy}%`;

            let gradeIcon = 'üéØ';
            if (accuracy >= 90) {
                gradeIcon = 'üèÜ';
            } else if (accuracy >= 80) {
                gradeIcon = 'üéâ';
            } else if (accuracy >= 70) {
                gradeIcon = 'üëç';
            } else if (accuracy >= 60) {
                gradeIcon = 'üìö';
            } else {
                gradeIcon = 'üí™';
            }

            document.getElementById('test-grade-icon').textContent = gradeIcon;

            // Show detailed review
            const reviewContainer = document.getElementById('test-review-details');
            reviewContainer.innerHTML = '';

            questions.forEach((question, index) => {
                const userAnswer = answers[index];
                const correctOption = question.options.find(opt => opt.correct);
                const userOption = question.options.find(opt => opt.label === userAnswer);
                const isCorrect = correctOption && userAnswer === correctOption.label;

                const reviewCard = document.createElement('div');
                reviewCard.className = `border-l-4 p-4 bg-white rounded-lg shadow-sm ${isCorrect ? 'border-green-500' : 'border-red-500'}`;
                
                reviewCard.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-bold text-gray-800">Question ${index + 1}</h4>
                        <span class="text-2xl">${isCorrect ? '‚úÖ' : '‚ùå'}</span>
                    </div>
                    <p class="text-gray-700 mb-3">${question.text}</p>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <strong class="text-gray-600">Your Answer:</strong><br>
                            <span class="${isCorrect ? 'text-green-600' : 'text-red-600'}">${userAnswer}. ${userOption?.text || 'Not answered'}</span>
                        </div>
                        <div>
                            <strong class="text-gray-600">Correct Answer:</strong><br>
                            <span class="text-green-600">${question.correctAnswer}</span>
                        </div>
                    </div>
                    ${question.explanationHTML ? `
                        <div class="mt-3 p-3 bg-blue-50 rounded-lg">
                            <strong class="text-blue-800">Explanation:</strong>
                            <div class="mt-2 explanation-content">${question.explanationHTML}</div>
                        </div>
                    ` : ''}
                `;
                
                reviewContainer.appendChild(reviewCard);
            });
        }

        function showNormalModeResults() {
            const accuracy = (correctCount + incorrectCount === 0) ? 0 : Math.round((correctCount / (correctCount + incorrectCount)) * 100);

            document.getElementById('quiz-section').classList.add('hidden');
            document.getElementById('final-results').classList.remove('hidden');

            document.getElementById('final-correct').textContent = correctCount;
            document.getElementById('final-incorrect').textContent = incorrectCount;
            document.getElementById('final-accuracy').textContent = `${accuracy}%`;

            let gradeIcon = 'üéØ';
            if (accuracy >= 90) {
                gradeIcon = 'üèÜ';
            } else if (accuracy >= 80) {
                gradeIcon = 'üéâ';
            } else if (accuracy >= 70) {
                gradeIcon = 'üëç';
            } else if (accuracy >= 60) {
                gradeIcon = 'üìö';
            } else {
                gradeIcon = 'üí™';
            }

            document.getElementById('final-grade-icon').textContent = gradeIcon;
        }
    </script>
</body>
</html>